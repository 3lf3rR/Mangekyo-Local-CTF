/* compile: gcc -o main main.c -lseccomp  -Wl,-z,relro,-z,now
+PIE + GOT FULL RELRO + NX
*/ 
#include <unistd.h>
#include <string.h>
#include <seccomp.h>
#include <sys/prctl.h>
#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#define MAX_ALLOCS 5
#define _GNU_SOURCE

void install_seccomp() {
    scmp_filter_ctx ctx;
    int r;

    /* Default: kill the process on an unallowed syscall */
    ctx = seccomp_init(SCMP_ACT_KILL); 
    if (!ctx) {
        perror("seccomp_init");
        exit(1);
    }

    /* Allow basic syscalls needed by most C programs */
    #define ALLOW(s) do { r = seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(s), 0); \
                          if (r < 0) { fprintf(stderr, "rule add %s failed: %d\n", #s, r); exit(1); } } while (0)

    ALLOW(read);
    ALLOW(write);
    ALLOW(close);
    ALLOW(open);
    ALLOW(openat);
    ALLOW(fstat);
    ALLOW(lseek);
    ALLOW(mmap);
    ALLOW(munmap);
    ALLOW(brk);
    ALLOW(rt_sigreturn);
    ALLOW(exit);
    ALLOW(exit_group);
    ALLOW(arch_prctl);
    ALLOW(ioctl);
    ALLOW(getrandom);
    ALLOW(futex);


    #undef ALLOW


    if (seccomp_load(ctx) < 0) {
        perror("seccomp_load");
        seccomp_release(ctx);
        exit(1);
    }

    seccomp_release(ctx);
}




typedef struct {
    char event[0x10];
    char description[0x100];
    int day;
    int month;
    int year;

}Calendar;

typedef Calendar *alloc_entry_t;

alloc_entry_t MyCalendar[MAX_ALLOCS];


void read_flag(){
    FILE* fd=fopen("flag","r");
    char buf[10];
    fread(buf,1,10,fd);
    memset(buf,'\x00',10);
    //did i forget sth?

}
void setup(){
    install_seccomp();
    setbuf(stdout,0);
    setbuf(stdin,0); 
    setbuf(stderr,0);
}
void menu(){
printf("=================================\n");
printf(" Syndicate Calendar Manager\n");
printf("=================================\n");
printf("1) Add event\n");
printf("2) Edit event\n");
printf("3) Delete event\n");
printf("4) View event\n");
printf("6) Exit\n");
printf("Choose> ");
}

void add(){
    int idx;
    printf("Index : \n");
    scanf("%d",&idx);
    if(MyCalendar[idx]!=0){
        printf("Invalid Index!! \n");
        return;
    }
    MyCalendar[idx]=malloc(0x11c);
    printf("Name of the event : ");
    read(0,MyCalendar[idx]->event,0x10);
    printf("\nDescription of the event : ");
    read(0,MyCalendar[idx]->description,0x10);
    do{
        printf("\nDate:\nDay: ");
        scanf("%d",&(MyCalendar[idx]->day));
    }while(MyCalendar[idx]->day>31);
    do{
        printf("\nMonth: ");
        scanf("%d",&(MyCalendar[idx]->month));
    }while(MyCalendar[idx]->month>12);
    printf("\nYear: ");
    scanf("%d",&(MyCalendar[idx]->year));
    printf("\n");
    
}

int c=0;
void edit(){
    if(c==0){
        int idx;
        printf("Edit Index : \n");
        scanf("%d",&idx);
        if(MyCalendar[idx]==0){
            printf("Invalid Index!! \n");
            return;
        }
        printf("Edit name of the event : ");
        read(0,MyCalendar[idx]->event,0x10);
        printf("\nEdit description of the event : ");
        read(0,MyCalendar[idx]->description,0x10);
        do{
            printf("\nEdit date:\nDay: ");
            scanf("%d",&(MyCalendar[idx]->day));
        }while(MyCalendar[idx]->day>31);
        do{
            printf("\nMonth: ");
            scanf("%d",&(MyCalendar[idx]->month));
        }while(MyCalendar[idx]->month>12);
        printf("\nYear: ");
        scanf("%d",&(MyCalendar[idx]->year));
        printf("\n");
        c++;}
    else{
        printf("You have only one free edit!\n");
        return;
    }

}
void delete(){
    int idx;
    printf("Delete Index : \n");
    scanf("%d",&idx);
    if(MyCalendar[idx]==0){
        printf("Invalid Index!! \n");
        return;
    }

    memset(MyCalendar[idx]->event,'\x00',0x10);
    memset(MyCalendar[idx]->description,'\x00',0x100);
    MyCalendar[idx]->day=0;
    MyCalendar[idx]->month=0;
    MyCalendar[idx]->year=0;
    free(MyCalendar[idx]);
}
void view(){
    int idx;
    printf("Index to inspect : \n");
    scanf("%d",&idx);
    if(MyCalendar[idx]==0){
        printf("Invalid Index!! \n");
        return;
    }
    printf("Name of the event : ");
    write(1,MyCalendar[idx]->event,strlen(MyCalendar[idx]->event));
    printf("\nDescription of the event : ");
    write(1,MyCalendar[idx]->description,strlen(MyCalendar[idx]->description));
    printf("\nDate:\nDay: ");
    printf("%d",&(MyCalendar[idx]->day));
    printf("\nMonth: ");
    printf("%d",&(MyCalendar[idx]->month));
    printf("\nYear: ");
    printf("%d\n",&(MyCalendar[idx]->year));
    
}
void main(){
    int choice;
    read_flag();
    setup();
    while(1){
        menu();
        scanf("%d",&choice);
        if(choice==1)
            add();
    
        else if(choice==2)
            edit();
        else if(choice==3)
            delete();
        else if (choice==4)
            view();
        
        else if (choice==5)
            exit(0);
        else
            printf("Incorrect Choice!\n");  
    }
}